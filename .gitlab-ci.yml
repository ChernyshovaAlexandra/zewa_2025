image: node:20

stages:
  - build
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .yarn/cache
    - node_modules/

build_dev:
  stage: build
  only:
    - develop
  before_script:
    - yarn install --frozen-lockfile
  script:
    - yarn build:dev
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

# deploy –Ω–∞ develop
deploy_dev:
  stage: deploy
  image: node:20
  only:
    - develop
  before_script:
    - apt-get update -y && apt-get install -y openssh-client rsync
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY_DEV" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
  script:
    # —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    - rsync -avz --delete dist/ "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH"
    # –ø–æ –∫–æ–¥—É –≤–æ–∑–≤—Ä–∞—Ç–∞ rsync –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤ Telegram
    - |
      RSYNC_CODE=$?  # —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –∫–æ–¥ rsync
      SUCCESS=(
        "üêô tf2.anilau.com –ø–µ—Ä–µ–∂–∏–ª –µ—â—ë –æ–¥–∏–Ω –¥–µ–ø–ª–æ–π. –ú—ã —Ç–æ–∂–µ."
      )
      FAIL=(
        "üòæ –û–ø—è—Ç—å —á—Ç–æ‚Äë—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ ‚Äî tf2.anilau.com –æ—Å—Ç–∞–ª—Å—è –Ω–∞ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏."
       )

      if [ $RSYNC_CODE -eq 0 ]; then
        STATUS="${SUCCESS[$RANDOM % ${#SUCCESS[@]}]}"
      else
        STATUS="${FAIL[$RANDOM % ${#FAIL[@]}]}"
      fi
      curl -s -X POST https://api.telegram.org/bot8181248379:AAE2sk_bmppXN4xZosh4pprYAgc0DGTfx9Y/sendMessage \
        -d chat_id=-4839926681 \
        -d parse_mode=Markdown \
        -d text="$STATUS"

build_prod:
  stage: build
  only:
    - main
  before_script:
    - yarn install --frozen-lockfile
  script:
    - yarn build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
# deploy –Ω–∞ main (production)
deploy_prod:
  stage: deploy
  image: node:20
  only:
    - main
  before_script:
    - apt-get update -y && apt-get install -y openssh-client rsync
    - mkdir -p ~/.ssh
    - printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$PROD_DEPLOY_HOST" >> ~/.ssh/known_hosts
  script:
    # —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –Ω–∞ –ø—Ä–æ–¥
    - rsync -avz --delete dist/ "$PROD_DEPLOY_USER@$PROD_DEPLOY_HOST:$PROD_DEPLOY_PATH"
    - |
      RSYNC_CODE=$?
      # –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ –∂–µ –º–∞—Å—Å–∏–≤—ã SUCCESS/FAIL,
      # –ª–∏–±–æ –∑–∞–≤–µ—Å—Ç–∏ —Å–≤–æ–∏, –±–æ–ª–µ–µ ‚Äú–ø—Ä–æ–¥–æ–≤—ã–µ‚Äù —Å–æ–æ–±—â–µ–Ω–∏—è.
      if [ $RSYNC_CODE -eq 0 ]; then
        STATUS="üéâ –ü—Ä–æ–¥–∞–∫—à–Ω –æ–±–Ω–æ–≤–ª—ë–Ω —É—Å–ø–µ—à–Ω–æ –Ω–∞ $PROD_DEPLOY_HOST!"
      else
        STATUS="üí• –û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω $PROD_DEPLOY_HOST."
      fi
      curl -s -X POST https://api.telegram.org/bot8181248379:AAE2sk_bmppXN4xZosh4pprYAgc0DGTfx9Y/sendMessage \
        -d chat_id=-4839926681 \
        -d parse_mode=Markdown \
        -d text="$STATUS"